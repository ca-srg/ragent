# RAGにおけるスコアの考え方

## このドキュメントの目的

`ragent` の検索結果に含まれる `score` フィールドが何を意味するのか、RAG (Retrieval-Augmented Generation) を初めて扱う方にも分かりやすく解説します。BM25 やベクトル検索の基礎、ハイブリッドスコアの仕組み、スコアを活用する際のポイントをまとめています。

---

## RAG検索で使われる3種類のスコア

RAG では複数の検索手法を組み合わせることで精度を高めます。本プロジェクトでは以下のスコアが存在します。

1. **BM25 スコア**
   - 用途: キーワード (単語) の一致度を評価する検索手法。
   - 特徴: クエリとドキュメント内の単語がどれだけ重なっているかを重み付きで算出します。
   - 値の範囲: 制限はなく、クエリ内容によって 0〜数十程度まで幅広く変動します。

2. **ベクトル類似度スコア**
   - 用途: クエリとドキュメントをベクトル化し、意味的な近さを測ります。
   - 特徴: コサイン類似度などの指標を利用します。単語が一致していなくても、文意が近い文章を見つけられます。
   - 値の範囲: 0〜1 の範囲に収まることが多く、小数点以下の値です。

3. **ハイブリッド (FusedScore)**
   - 用途: BM25 とベクトル検索の結果を統合して最終的なランキングを決めるためのスコア。
   - 特徴: `RRF` (Reciprocal Rank Fusion) や `weighted_sum` などのアルゴリズムで BM25/ベクトルの結果を正規化・融合します。
   - 値の範囲: 0〜1 を基本とし、融合方法によって調整された相対的な値になります。

`mcp-server` のレスポンスに含まれる `score` は、この **ハイブリッド後の `FusedScore`** です。

---

## スコアがどのように計算されるか

1. クエリを受け取ると、まず BM25 検索とベクトル検索を並列で実行します。
2. それぞれの検索で得られた上位ドキュメントには、個別の `_score` (BM25) と類似度スコア (ベクトル) が付与されます。
3. FusionEngine が以下の処理を行い、最終的な `FusedScore` を算出します。
   - スコアを互いに比較できるよう正規化する。
   - 検索手法ごとの重み (例: `bm25_weight`, `vector_weight`) を適用する。
   - スコアを加算・最大値化・順位ベースの合成など、指定された融合メソッドで統合する。
4. 結果として得られた `FusedScore` を基に最終順位付けを行い、MCPレスポンスの `score` として返します。

---

## スコアの解釈ポイント

- **スコアは相対値です**: 0.3 と 0.6 の差は、絶対的な品質差ではなく、同じクエリの結果内での相対的な順位を示します。
- **検索モードに依存します**: BM25 のみ／ベクトルのみ／ハイブリッドで値の分布が変わります。特にベクトル検索では 1 未満の値が一般的です。
- **閾値を決める際は検証が必須**: `score < 0.1 なら再検索` のようなルールを導入する場合は、実データでの分布を分析したうえで設定してください。
- **メタデータとの併用が有効**: スコアだけで判断せず、カテゴリやタグ、更新日時などのメタ情報も併せて評価すると品質向上につながります。

---

## `min_score` パラメータとフィルタリング

`HybridSearchRequest` では `min_score` を指定できます。これは FusionEngine が `FusedScore` に対して適用する下限値です。

- `min_score` を高く設定すると、低スコアの文書を自動的に除外できます。
- 高すぎる閾値は有用なドキュメントまで除外してしまう可能性があるため、スコア分布を分析したうえで調整してください。

---

## どのような時にスコアを使うべきか

| ユースケース | 推奨される判断基準 |
|---------------|----------------------|
| 検索結果をユーザーに表示する | `FusedScore` の降順で並べ、上位数件を提示する。 |
| LLM へのコンテキスト投入 | `FusedScore` が一定以上のものを選び、余裕があれば BM25/ベクトルの内訳もログとして保存する。 |
| 自動再検索・フォールバック | スコアとヒット件数の両方を確認し、条件を満たさない場合に再検索パラメータを調整する。 |

---

## よくある質問 (FAQ)

### Q. `score` の値だけで「正解かどうか」を判断できますか？
A. 難しいです。スコアはあくまでランキング指標であり、万能な真理値ではありません。重要な意思決定には内容の確認が必要です。

### Q. スコアをログに保存するべきですか？
A. 推奨します。後から閾値のチューニングや異常検知を行う際に役立ちます。

### Q. どの融合メソッドを使っているかでスコアは変わりますか？
A. はい。`weighted_sum` では重みによって値が変化し、`rrf` では順位ベースのスコアになります。用途に応じてメソッドを選択してください。

---

## 参考リンク

- [README.md - Available MCP Tools](../README.md#available-mcp-tools)
- [doc/mcp-server.md](./mcp-server.md)
- OpenSearch 公式ドキュメント: [BM25](https://opensearch.org/docs/latest/search-plugins/bm25/) / [k-NN](https://opensearch.org/docs/latest/search-plugins/knn/)

---

## 次のステップ

- 実際の検索ログを収集し、スコア分布を可視化する (例: ヒストグラム)。
- `min_score` や `top_k` を調整し、目的の品質に合う閾値を検証する。
- LLM 応答の品質評価と組み合わせて、スコアしきい値の再検討を定期的に行う。

このドキュメントが `score` の正しい活用に役立つことを願っています。
