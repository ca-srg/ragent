# Web UI 実装計画

## 概要

RAGent に Web UI を追加し、vectorize の進捗状態、次回実行予定、処理ファイル、エラーの確認、および対象ファイルの検索機能を提供する。

## 技術選定

| 項目 | 選定 |
|------|------|
| コマンド | `./RAGent webui` |
| フロントエンド | Go templates + HTMX |
| リアルタイム更新 | SSE (Server-Sent Events) |
| HTTP サーバー | 標準 `net/http` |
| 認証 | なし（ローカル使用のみ） |

## アーキテクチャ

webui コマンドは VectorizerService を内部に統合し、単一プロセスで動作する。

```
┌─────────────────────────────────────────────────────────────────┐
│                         webui プロセス                           │
│  ┌─────────────┐    ┌──────────────────┐    ┌────────────────┐  │
│  │  HTTP Server │◄──►│ WebUI Controller │◄──►│ VectorizerSvc  │  │
│  │  (net/http)  │    │                  │    │  (embedded)    │  │
│  └──────┬───────┘    └────────┬─────────┘    └───────┬────────┘  │
│         │                     │                       │          │
│         ▼                     ▼                       ▼          │
│  ┌─────────────┐    ┌──────────────────┐    ┌────────────────┐  │
│  │ SSE Manager │    │  State Manager   │◄──►│ File Scanner   │  │
│  └─────────────┘    └──────────────────┘    └────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## ファイル構造

```
cmd/
└── webui.go                          # Cobra コマンド定義

internal/
└── webui/
    ├── server.go                     # HTTP サーバー・ルーティング
    ├── handlers.go                   # ページハンドラー
    ├── api_handlers.go               # REST API ハンドラー
    ├── sse_handlers.go               # SSE エンドポイント
    ├── sse_manager.go                # SSE クライアント管理
    ├── state.go                      # 状態管理 (VectorizeState)
    ├── scheduler.go                  # Follow モードスケジューラ
    ├── types.go                      # WebUI 固有の型定義
    ├── templates.go                  # テンプレート埋め込み・関数
    ├── templates/
    │   ├── base.html                 # ベーステンプレート
    │   ├── index.html                # ダッシュボード
    │   ├── files.html                # ファイルブラウザ
    │   ├── history.html              # 処理履歴
    │   └── partials/
    │       ├── progress.html         # 進捗バー (HTMX partial)
    │       ├── stats.html            # 統計情報 (HTMX partial)
    │       ├── file_list.html        # ファイル一覧 (HTMX partial)
    │       └── error_list.html       # エラー一覧 (HTMX partial)
    └── static/
        ├── css/
        │   └── style.css             # カスタムスタイル
        └── js/
            └── htmx.min.js           # HTMX ライブラリ (v2.0.4)
```

## 実装タスク

### Phase 1: 基盤構築

1. **`internal/webui/types.go`** - 型定義
   - `VectorizeStatus` (idle/running/error/stopping)
   - `VectorizeProgressEvent`
   - `RunInfo`, `ErrorInfo`, `SchedulerState`
   - SSE イベント定数

2. **`internal/webui/sse_manager.go`** - SSE 管理
   - クライアント登録・解除
   - イベントブロードキャスト
   - ハートビート (30秒間隔)

3. **`internal/webui/state.go`** - 状態管理
   - `VectorizeState` 構造体
   - `StartRun()`, `UpdateProgress()`, `CompleteRun()`, `FailRun()`
   - 履歴管理 (最新100件)
   - エラー管理 (最新50件)

4. **`internal/webui/scheduler.go`** - スケジューラ
   - Follow モード管理
   - インターバル設定
   - 次回実行時刻計算

### Phase 2: HTTP サーバー

5. **`internal/webui/server.go`** - サーバー本体
   - ルーティング設定
   - VectorizerService 初期化
   - Graceful shutdown

6. **`internal/webui/templates.go`** - テンプレート
   - `//go:embed` でテンプレート埋め込み
   - カスタム関数 (formatSize, formatDuration)

7. **`cmd/webui.go`** - CLI コマンド
   - `--host`, `--port` フラグ
   - シグナルハンドリング

### Phase 3: API エンドポイント

8. **`internal/webui/handlers.go`** - ページハンドラー
   - `GET /` - ダッシュボード
   - `GET /files` - ファイルブラウザ
   - `GET /history` - 処理履歴

9. **`internal/webui/api_handlers.go`** - REST API
   - `GET /api/status` - 現在のステータス
   - `POST /api/vectorize/start` - Vectorize 開始
   - `POST /api/vectorize/stop` - Vectorize 停止
   - `GET /api/files?search=keyword` - ファイル検索
   - `GET /api/history` - 処理履歴
   - `GET/POST /api/scheduler/*` - スケジューラ制御

10. **`internal/webui/sse_handlers.go`** - SSE
    - `GET /sse/progress` - 進捗リアルタイム更新
    - `GET /sse/events` - 全イベントストリーム

### Phase 4: フロントエンド

11. **`internal/webui/templates/base.html`** - ベースレイアウト
    - ナビゲーション
    - HTMX/SSE 読み込み
    - 接続状態表示

12. **`internal/webui/templates/index.html`** - ダッシュボード
    - ステータスカード
    - コントロールパネル (開始/停止ボタン)
    - スケジューラ設定
    - 進捗表示 (SSE 連携)
    - 最近のエラー

13. **`internal/webui/templates/files.html`** - ファイルブラウザ
    - 検索入力 (HTMX: keyup delay:300ms)
    - ファイル統計
    - ファイルテーブル

14. **`internal/webui/templates/history.html`** - 処理履歴
    - 実行履歴テーブル
    - エラー詳細表示

15. **`internal/webui/templates/partials/*.html`** - パーシャル
    - progress.html, stats.html, file_list.html, error_list.html

16. **`internal/webui/static/css/style.css`** - スタイル
    - レスポンシブレイアウト
    - プログレスバー
    - テーブルスタイル

17. **`internal/webui/static/js/htmx.min.js`** - HTMX ライブラリ

### Phase 5: 設定・統合

18. **`internal/types/types.go`** - 設定追加
    ```go
    WebUIHost            string        `env:"WEBUI_HOST,default=localhost"`
    WebUIPort            int           `env:"WEBUI_PORT,default=8081"`
    WebUIReadTimeout     time.Duration `env:"WEBUI_READ_TIMEOUT,default=30s"`
    WebUIWriteTimeout    time.Duration `env:"WEBUI_WRITE_TIMEOUT,default=30s"`
    WebUIShutdownTimeout time.Duration `env:"WEBUI_SHUTDOWN_TIMEOUT,default=30s"`
    ```

19. **`cmd/root.go`** - コマンド登録
    - `rootCmd.AddCommand(webuiCmd)`

## REST API 設計

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/` | ダッシュボードページ |
| `GET` | `/files` | ファイルブラウザページ |
| `GET` | `/history` | 処理履歴ページ |
| `GET` | `/api/status` | 現在のステータス (JSON) |
| `GET` | `/api/stats` | 処理統計 (JSON) |
| `POST` | `/api/vectorize/start` | Vectorize 開始 |
| `POST` | `/api/vectorize/stop` | Vectorize 停止 |
| `GET` | `/api/vectorize/progress` | 進捗情報 (JSON) |
| `GET` | `/api/files` | ファイル一覧 (JSON) |
| `GET` | `/api/files?search=keyword` | ファイル検索 |
| `GET` | `/api/history` | 処理履歴 (JSON) |
| `GET` | `/api/errors` | エラー一覧 (JSON) |
| `GET` | `/api/scheduler/status` | スケジューラ状態 |
| `POST` | `/api/scheduler/start` | Follow モード開始 |
| `POST` | `/api/scheduler/stop` | Follow モード停止 |
| `PUT` | `/api/scheduler/interval` | インターバル変更 |
| `GET` | `/sse/progress` | 進捗 SSE ストリーム |
| `GET` | `/sse/events` | 全イベント SSE ストリーム |

## SSE イベント

| Event Type | Description |
|------------|-------------|
| `vectorize_started` | Vectorize 開始 |
| `vectorize_progress` | 進捗更新 (10%毎) |
| `vectorize_completed` | Vectorize 完了 |
| `vectorize_failed` | Vectorize 失敗 |
| `file_processed` | ファイル処理完了 |
| `file_error` | ファイル処理エラー |
| `scheduler_tick` | スケジューラ次回実行時刻更新 |
| `heartbeat` | 接続確認 (30秒毎) |

## 検証方法

### 1. ビルド確認
```bash
go build -o RAGent
go vet ./...
go fmt ./...
```

### 2. サーバー起動
```bash
./RAGent webui --port 8081
# ブラウザで http://localhost:8081 にアクセス
```

### 3. 機能テスト
- ダッシュボード表示
- Vectorize 開始/停止
- 進捗リアルタイム更新 (SSE)
- ファイル検索
- スケジューラ設定
- 履歴・エラー表示

### 4. ユニットテスト
```bash
go test ./internal/webui/...
```

## 主要ファイルパス

- `cmd/webui.go` - CLI コマンド (新規)
- `cmd/root.go:33-39` - コマンド登録
- `internal/types/types.go` - 設定追加
- `internal/vectorizer/service.go` - VectorizerService (既存、再利用)
- `internal/scanner/scanner.go` - FileScanner (既存、再利用)

## 注意事項

1. HTMX は CDN ではなく静的ファイルとして埋め込む (オフライン対応)
2. テンプレートは `//go:embed` で埋め込み、バイナリ単体で動作可能に
3. VectorizerService の初期化は `cmd/vectorize.go` のパターンを踏襲
4. エラー処理は既存の `ProcessingError` 型を活用
